name: Snyk Security

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  snyk:
    name: Snyk Scans (Code, OSS, IaC, Container)
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      actions: read

    # Make SNYK_TOKEN available to ALL subsequent run steps
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Secrets are not available for PRs from forks.
      # This workflow skips Snyk scans in that case to avoid failing PR checks.
      - name: Determine if PR is from fork
        id: fork_check
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "is_fork=true" >> $GITHUB_OUTPUT
          else
            echo "is_fork=false" >> $GITHUB_OUTPUT
          fi

      - name: Explain skip (fork PR)
        if: steps.fork_check.outputs.is_fork == 'true'
        run: |
          echo "Skipping Snyk scans because this is a PR from a fork and GitHub does not provide secrets to forked PR workflows."

      # Optional but recommended for Snyk Open Source (dependency scanning) in Node projects
      - name: Setup Node
        if: steps.fork_check.outputs.is_fork == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # If you use pnpm/yarn, adjust accordingly
      - name: Install dependencies (optional, recommended for OSS scan)
        if: steps.fork_check.outputs.is_fork == 'false'
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          elif [ -f package.json ]; then
            npm install
          else
            echo "No package.json found; skipping npm install."
          fi

      - name: Set up Snyk CLI
        if: steps.fork_check.outputs.is_fork == 'false'
        uses: snyk/actions/setup@806182742461562b67788a64410098c9d9b96adb

      # (Optional) Fast sanity check that token is present (does not print token)
      - name: Verify SNYK_TOKEN is present
        if: steps.fork_check.outputs.is_fork == 'false'
        shell: bash
        run: |
          if [ -z "${SNYK_TOKEN}" ]; then
            echo "SNYK_TOKEN is missing. Add it in GitHub repo Settings > Secrets and variables > Actions."
            exit 1
          fi
          echo "SNYK_TOKEN is present."

      # --- Snyk Code (SAST) -> SARIF for GitHub Code Scanning ---
      - name: Snyk Code test (SARIF)
        if: steps.fork_check.outputs.is_fork == 'false'
        shell: bash
        run: |
          # Non-blocking by default; remove "|| true" to fail the job on findings/errors.
          snyk code test --sarif > snyk-code.sarif || true

          # Ensure file exists to avoid upload errors
          if [ ! -s snyk-code.sarif ]; then
            echo "SARIF file was not generated or is empty."
          fi

      - name: Upload SARIF to GitHub Code Scanning
        if: steps.fork_check.outputs.is_fork == 'false' && hashFiles('snyk-code.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk-code.sarif

      # --- Snyk Open Source (SCA) ---
      - name: Snyk Open Source monitor (all projects)
        if: steps.fork_check.outputs.is_fork == 'false'
        shell: bash
        run: |
          # Non-blocking by default
          snyk monitor --all-projects || true

      # --- Snyk Infrastructure as Code (IaC) ---
      - name: Snyk IaC test and report
        if: steps.fork_check.outputs.is_fork == 'false'
        shell: bash
        run: |
          # Non-blocking by default
          snyk iac test --report || true

      # --- Container scan (uncomment when you have a Dockerfile) ---
      # - name: Build Docker image
      #   if: steps.fork_check.outputs.is_fork == 'false'
      #   run: docker build -t goalflow-agent .
      #
      # - name: Snyk Container monitor
      #   if: steps.fork_check.outputs.is_fork == 'false'
      #   shell: bash
      #   run: |
      #     # Non-blocking by default
      #     snyk container monitor goalflow-agent --file=Dockerfile || true
